name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SCHEME: Meridian
  PROJECT: Clocker/Clocker.xcodeproj
  CODE_SIGNING_REQUIRED: "NO"
  CODE_SIGNING_ALLOWED: "NO"
  CODE_SIGN_IDENTITY: ""
  NSUnbufferedIO: "YES"

jobs:
  build-and-lint:
    name: Build & Lint
    runs-on: macos-15
    env:
      TZ: America/Chicago
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('Clocker/Clocker.xcodeproj/project.pbxproj', 'Clocker/CoreLoggerKit/Package.swift', 'Clocker/CoreModelKit/Package.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: SwiftLint
        run: |
          brew install swiftlint
          swiftlint

      - name: Build & Analyze
        run: |
          set -o pipefail
          xcodebuild -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Debug \
            build analyze \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY= \
            | xcpretty

  unit-tests:
    name: Unit Tests
    runs-on: macos-15
    needs: build-and-lint
    env:
      TZ: America/Chicago
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('Clocker/Clocker.xcodeproj/project.pbxproj', 'Clocker/CoreLoggerKit/Package.swift', 'Clocker/CoreModelKit/Package.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Debug \
            test \
            -only-testing:ClockerUnitTests \
            -disable-concurrent-destination-testing \
            -parallel-testing-enabled NO \
            -enableCodeCoverage YES \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY= \
            -resultBundlePath TestResults/unit-tests.xcresult \
            | xcpretty

      - name: Test Results Summary
        if: always()
        continue-on-error: true
        uses: kishikawakatsumi/xcresulttool@v1
        with:
          path: TestResults/unit-tests.xcresult
          show-passed-tests: false
          show-code-coverage: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: TestResults/
